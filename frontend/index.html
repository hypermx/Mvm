<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MVM – Migraine Vulnerability Modeling</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1117;
      --surface: #1a1d2e;
      --surface2: #252840;
      --accent: #7c6af7;
      --accent2: #4ecdc4;
      --danger: #ff6b6b;
      --text: #e2e8f0;
      --text-muted: #8892a4;
      --border: #2d3148;
      --radius: 12px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    header h1 { font-size: 1.25rem; font-weight: 700; }
    header span { color: var(--accent); }
    header .tagline { color: var(--text-muted); font-size: 0.85rem; margin-left: auto; }

    nav {
      display: flex;
      gap: 0.5rem;
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    nav button {
      padding: 0.4rem 1rem;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    nav button.active, nav button:hover {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    main { padding: 2rem; max-width: 1100px; margin: 0 auto; }

    .section { display: none; }
    .section.active { display: block; }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card h2 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }

    /* Grid */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }

    /* Vulnerability gauge */
    .gauge-wrap { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }

    .gauge {
      width: 160px; height: 80px;
      position: relative;
      overflow: hidden;
    }

    .gauge svg { width: 100%; height: 100%; }

    .gauge-value {
      font-size: 2rem;
      font-weight: 700;
    }

    .gauge-label { color: var(--text-muted); font-size: 0.875rem; }

    /* Stat tiles */
    .stat { text-align: center; padding: 1rem; }
    .stat .val { font-size: 1.75rem; font-weight: 700; }
    .stat .lbl { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem; }

    /* Form */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

    .field { display: flex; flex-direction: column; gap: 0.4rem; }
    .field label { font-size: 0.825rem; color: var(--text-muted); }
    .field input, .field select {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s;
    }
    .field input:focus, .field select:focus { border-color: var(--accent); }

    .field input[type="range"] {
      padding: 0;
      cursor: pointer;
      accent-color: var(--accent);
    }

    .range-row { display: flex; align-items: center; gap: 0.75rem; }
    .range-row span { min-width: 2ch; font-size: 0.9rem; font-weight: 600; color: var(--accent); }

    button.primary {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.5rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: opacity 0.2s;
      margin-top: 1rem;
    }
    button.primary:hover { opacity: 0.85; }
    button.primary:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Trajectory chart */
    .chart-container { width: 100%; height: 180px; position: relative; }
    canvas { width: 100%; height: 100%; }

    /* Intervention cards */
    .intervention {
      background: var(--surface2);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
    }

    .intervention .details { flex: 1; }
    .intervention .type { font-weight: 600; margin-bottom: 0.25rem; }
    .intervention .desc { font-size: 0.85rem; color: var(--text-muted); }

    .badge {
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0.2rem 0.6rem;
      border-radius: 20px;
      white-space: nowrap;
    }
    .badge.green { background: #1a3a2a; color: #4ade80; }
    .badge.yellow { background: #3a3010; color: #facc15; }
    .badge.red { background: #3a1010; color: var(--danger); }

    /* User setup */
    .user-bar {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .user-bar input {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      padding: 0.4rem 0.75rem;
      font-size: 0.9rem;
      outline: none;
      flex: 1;
      max-width: 220px;
    }
    .user-bar .uid { color: var(--accent); font-weight: 600; }

    /* Alerts */
    .alert {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    .alert.success { background: #1a3a2a; color: #4ade80; border: 1px solid #256040; }
    .alert.error { background: #3a1010; color: var(--danger); border: 1px solid #602020; }

    @media (max-width: 700px) {
      .grid-2, .form-grid, .grid-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <h1>M<span>VM</span></h1>
  <div>
    <div style="font-weight:600;">Migraine Vulnerability Modeling</div>
    <div class="tagline">Threshold-crossing latent state-space model</div>
  </div>
</header>

<nav>
  <button class="active" onclick="showSection('dashboard', this)">Dashboard</button>
  <button onclick="showSection('log', this)">Log Today</button>
  <button onclick="showSection('simulate', this)">Simulate</button>
  <button onclick="showSection('interventions', this)">Interventions</button>
</nav>

<main>

  <!-- User bar (shared) -->
  <div class="user-bar">
    <span style="color:var(--text-muted);font-size:.85rem;">User ID:</span>
    <input id="userId" type="text" placeholder="e.g. user_001" value="user_001" />
    <button class="primary" style="margin-top:0" onclick="ensureUser()">Connect</button>
    <span id="userStatus" style="color:var(--text-muted);font-size:.85rem;"></span>
  </div>

  <div id="alertBox"></div>

  <!-- ── Dashboard ──────────────────────────────────────────────── -->
  <section id="dashboard" class="section active">
    <div class="grid-2">
      <div class="card">
        <h2>Current Vulnerability</h2>
        <div class="gauge-wrap">
          <div class="gauge">
            <svg viewBox="0 0 160 80">
              <path d="M10 75 A70 70 0 0 1 150 75" fill="none" stroke="#2d3148" stroke-width="12" stroke-linecap="round"/>
              <path id="gaugeFill" d="M10 75 A70 70 0 0 1 150 75" fill="none" stroke="#7c6af7" stroke-width="12" stroke-linecap="round"
                    stroke-dasharray="220" stroke-dashoffset="220"/>
            </svg>
          </div>
          <div class="gauge-value" id="gaugeValue">—</div>
          <div class="gauge-label" id="gaugeLabel">No data yet</div>
          <button class="primary" style="margin-top:.5rem" onclick="refreshVulnerability()">Refresh</button>
        </div>
      </div>

      <div class="card">
        <h2>7-Day Trajectory</h2>
        <div class="chart-container">
          <canvas id="trajectoryCanvas"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Quick Stats</h2>
      <div class="grid-3">
        <div class="stat">
          <div class="val" id="statLogs">0</div>
          <div class="lbl">Logs Submitted</div>
        </div>
        <div class="stat">
          <div class="val" id="statConfidence">—</div>
          <div class="lbl">Model Confidence</div>
        </div>
        <div class="stat">
          <div class="val" id="statRisk" style="color:var(--danger)">—</div>
          <div class="lbl">Risk Level</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ── Log Today ──────────────────────────────────────────────── -->
  <section id="log" class="section">
    <div class="card">
      <h2>Daily Health Log</h2>
      <form id="logForm" onsubmit="submitLog(event)">
        <div class="form-grid">
          <div class="field">
            <label>Date</label>
            <input type="date" id="logDate" required />
          </div>
          <div class="field">
            <label>Sleep Hours</label>
            <div class="range-row">
              <input type="range" id="sleepHours" min="0" max="12" step="0.5" value="7.5"
                     oninput="document.getElementById('sleepHoursVal').textContent=this.value" />
              <span id="sleepHoursVal">7.5</span>
            </div>
          </div>
          <div class="field">
            <label>Sleep Quality (0–10)</label>
            <div class="range-row">
              <input type="range" id="sleepQuality" min="0" max="10" step="1" value="6"
                     oninput="document.getElementById('sleepQualityVal').textContent=this.value" />
              <span id="sleepQualityVal">6</span>
            </div>
          </div>
          <div class="field">
            <label>Stress Level (0–10)</label>
            <div class="range-row">
              <input type="range" id="stressLevel" min="0" max="10" step="1" value="4"
                     oninput="document.getElementById('stressLevelVal').textContent=this.value" />
              <span id="stressLevelVal">4</span>
            </div>
          </div>
          <div class="field">
            <label>Hydration (liters)</label>
            <div class="range-row">
              <input type="range" id="hydration" min="0" max="5" step="0.25" value="2.0"
                     oninput="document.getElementById('hydrationVal').textContent=this.value" />
              <span id="hydrationVal">2.0</span>
            </div>
          </div>
          <div class="field">
            <label>Caffeine (mg)</label>
            <div class="range-row">
              <input type="range" id="caffeine" min="0" max="800" step="25" value="100"
                     oninput="document.getElementById('caffeineVal').textContent=this.value" />
              <span id="caffeineVal">100</span>
            </div>
          </div>
          <div class="field">
            <label>Alcohol (units)</label>
            <div class="range-row">
              <input type="range" id="alcohol" min="0" max="10" step="0.5" value="0"
                     oninput="document.getElementById('alcoholVal').textContent=this.value" />
              <span id="alcoholVal">0</span>
            </div>
          </div>
          <div class="field">
            <label>Exercise (minutes)</label>
            <div class="range-row">
              <input type="range" id="exercise" min="0" max="180" step="5" value="20"
                     oninput="document.getElementById('exerciseVal').textContent=this.value" />
              <span id="exerciseVal">20</span>
            </div>
          </div>
          <div class="field">
            <label>Barometric Pressure (hPa)</label>
            <input type="number" id="pressure" min="950" max="1050" step="0.1" value="1013.25" />
          </div>
          <div class="field">
            <label>Migraine today?</label>
            <select id="migraineOccurred">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>
          <div class="field" id="intensityField" style="display:none">
            <label>Migraine Intensity (0–10)</label>
            <div class="range-row">
              <input type="range" id="migraineIntensity" min="0" max="10" step="1" value="5"
                     oninput="document.getElementById('migraineIntensityVal').textContent=this.value" />
              <span id="migraineIntensityVal">5</span>
            </div>
          </div>
        </div>
        <button type="submit" class="primary" id="logSubmitBtn">Submit Log</button>
      </form>
    </div>
  </section>

  <!-- ── Simulate ───────────────────────────────────────────────── -->
  <section id="simulate" class="section">
    <div class="card">
      <h2>Counterfactual Simulation</h2>
      <p style="color:var(--text-muted);font-size:.875rem;margin-bottom:1.25rem;">
        Ask "What if?" — modify inputs and see projected vulnerability trajectory over 7 days.
      </p>
      <div class="form-grid">
        <div class="field">
          <label>Hypothetical Sleep Hours</label>
          <div class="range-row">
            <input type="range" id="simSleep" min="0" max="12" step="0.5" value="8"
                   oninput="document.getElementById('simSleepVal').textContent=this.value" />
            <span id="simSleepVal">8</span>
          </div>
        </div>
        <div class="field">
          <label>Hypothetical Stress Level</label>
          <div class="range-row">
            <input type="range" id="simStress" min="0" max="10" step="1" value="3"
                   oninput="document.getElementById('simStressVal').textContent=this.value" />
            <span id="simStressVal">3</span>
          </div>
        </div>
        <div class="field">
          <label>Hypothetical Hydration (liters)</label>
          <div class="range-row">
            <input type="range" id="simHydration" min="0" max="5" step="0.25" value="2.5"
                   oninput="document.getElementById('simHydrationVal').textContent=this.value" />
            <span id="simHydrationVal">2.5</span>
          </div>
        </div>
        <div class="field">
          <label>Hypothetical Exercise (min)</label>
          <div class="range-row">
            <input type="range" id="simExercise" min="0" max="180" step="5" value="30"
                   oninput="document.getElementById('simExerciseVal').textContent=this.value" />
            <span id="simExerciseVal">30</span>
          </div>
        </div>
      </div>
      <button class="primary" onclick="runSimulation()">Run Simulation</button>

      <div id="simResults" style="display:none;margin-top:1.5rem;">
        <h2 style="margin-bottom:.75rem;">Projected Trajectory</h2>
        <div class="chart-container">
          <canvas id="simCanvas"></canvas>
        </div>
        <div class="grid-3" style="margin-top:1rem;">
          <div class="stat">
            <div class="val" id="simRisk">—</div>
            <div class="lbl">Predicted Risk</div>
          </div>
          <div class="stat">
            <div class="val" id="simUncertainty">—</div>
            <div class="lbl">Uncertainty</div>
          </div>
          <div class="stat">
            <div class="val" id="simSteps">7</div>
            <div class="lbl">Days Simulated</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ── Interventions ──────────────────────────────────────────── -->
  <section id="interventions" class="section">
    <div class="card">
      <h2>Intervention Suggestions</h2>
      <p style="color:var(--text-muted);font-size:.875rem;margin-bottom:1.25rem;">
        Evidence-based, personalised suggestions ranked by predicted risk reduction.
      </p>
      <button class="primary" onclick="loadInterventions()">Get Suggestions</button>
      <div id="interventionsList" style="margin-top:1.25rem;"></div>
    </div>
  </section>

</main>

<script>
  const API = '/api';
  let logCount = 0;
  let lastVulnerability = null;

  // ── Utilities ────────────────────────────────────────────────────────────

  function uid() { return document.getElementById('userId').value.trim(); }

  function showAlert(msg, type = 'success') {
    const el = document.getElementById('alertBox');
    el.innerHTML = `<div class="alert ${type}">${msg}</div>`;
    setTimeout(() => { el.innerHTML = ''; }, 4000);
  }

  function showSection(id, btn) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  // ── User ─────────────────────────────────────────────────────────────────

  async function ensureUser() {
    const id = uid();
    if (!id) { showAlert('Enter a user ID first.', 'error'); return; }
    // Try to get; if 404, create
    let res = await fetch(`${API}/users/${id}`);
    if (res.ok) {
      document.getElementById('userStatus').textContent = `✓ Connected as ${id}`;
      showAlert(`Connected as "${id}".`);
    } else {
      const body = { user_id: id, age: 30, sex: 'unknown', migraine_history_years: 1,
                     average_migraine_frequency: 2 };
      res = await fetch(`${API}/users`, { method: 'POST',
        headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      if (res.ok) {
        document.getElementById('userStatus').textContent = `✓ Created "${id}"`;
        showAlert(`User "${id}" created.`);
      } else {
        showAlert('Failed to create user.', 'error');
      }
    }
  }

  // ── Vulnerability ─────────────────────────────────────────────────────────

  async function refreshVulnerability() {
    const id = uid();
    const res = await fetch(`${API}/vulnerability/${id}`);
    if (!res.ok) { showAlert('Could not fetch vulnerability — connect a user first.', 'error'); return; }
    const data = await res.json();
    lastVulnerability = data;
    updateGauge(data.vulnerability_score, data.confidence);
    document.getElementById('statLogs').textContent = logCount;
    document.getElementById('statConfidence').textContent = (data.confidence * 100).toFixed(0) + '%';
    const risk = data.vulnerability_score >= 0.7 ? 'High' : data.vulnerability_score >= 0.4 ? 'Med' : 'Low';
    document.getElementById('statRisk').textContent = risk;
    document.getElementById('statRisk').style.color =
      data.vulnerability_score >= 0.7 ? 'var(--danger)' :
      data.vulnerability_score >= 0.4 ? '#facc15' : 'var(--accent2)';
  }

  function updateGauge(score, confidence) {
    const pct = Math.min(Math.max(score, 0), 1);
    const total = 220;
    const offset = total * (1 - pct);
    document.getElementById('gaugeFill').setAttribute('stroke-dashoffset', offset);
    document.getElementById('gaugeFill').setAttribute('stroke',
      pct >= 0.7 ? '#ff6b6b' : pct >= 0.4 ? '#facc15' : '#4ecdc4');
    document.getElementById('gaugeValue').textContent = (pct * 100).toFixed(0) + '%';
    document.getElementById('gaugeLabel').textContent =
      confidence > 0 ? `Confidence: ${(confidence * 100).toFixed(0)}%` : 'Needs more data';
    drawTrajectory('trajectoryCanvas', generateDemoTrajectory(score));
  }

  function generateDemoTrajectory(current) {
    // Synthesise a plausible 7-day history ending at the current score
    const pts = [];
    let v = Math.max(0, current - 0.3 + Math.random() * 0.2);
    for (let i = 0; i < 6; i++) {
      v = Math.min(1, Math.max(0, v + (Math.random() - 0.45) * 0.12));
      pts.push(v);
    }
    pts.push(current);
    return pts;
  }

  // ── Simple canvas chart ───────────────────────────────────────────────────

  function drawTrajectory(canvasId, data, threshold = 0.7) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const W = canvas.offsetWidth || 500;
    const H = canvas.offsetHeight || 180;
    canvas.width = W; canvas.height = H;
    ctx.clearRect(0, 0, W, H);

    const pad = { t: 16, b: 24, l: 32, r: 16 };
    const cW = W - pad.l - pad.r;
    const cH = H - pad.t - pad.b;

    // Grid
    ctx.strokeStyle = '#2d3148';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
      const y = pad.t + (cH / 4) * i;
      ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l + cW, y); ctx.stroke();
      ctx.fillStyle = '#8892a4';
      ctx.font = '10px sans-serif';
      ctx.fillText((1 - i / 4).toFixed(2), 2, y + 3);
    }

    // Threshold line
    const ty = pad.t + cH * (1 - threshold);
    ctx.strokeStyle = '#ff6b6b44';
    ctx.setLineDash([4, 4]);
    ctx.beginPath(); ctx.moveTo(pad.l, ty); ctx.lineTo(pad.l + cW, ty); ctx.stroke();
    ctx.setLineDash([]);

    if (!data || data.length < 2) return;

    const xStep = cW / (data.length - 1);

    // Fill
    ctx.beginPath();
    ctx.moveTo(pad.l, pad.t + cH * (1 - data[0]));
    for (let i = 1; i < data.length; i++) {
      ctx.lineTo(pad.l + xStep * i, pad.t + cH * (1 - data[i]));
    }
    ctx.lineTo(pad.l + cW, pad.t + cH);
    ctx.lineTo(pad.l, pad.t + cH);
    ctx.closePath();
    const grad = ctx.createLinearGradient(0, pad.t, 0, pad.t + cH);
    grad.addColorStop(0, '#7c6af766');
    grad.addColorStop(1, '#7c6af700');
    ctx.fillStyle = grad;
    ctx.fill();

    // Line
    ctx.strokeStyle = '#7c6af7';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(pad.l, pad.t + cH * (1 - data[0]));
    for (let i = 1; i < data.length; i++) {
      ctx.lineTo(pad.l + xStep * i, pad.t + cH * (1 - data[i]));
    }
    ctx.stroke();

    // Dots
    data.forEach((v, i) => {
      ctx.beginPath();
      ctx.arc(pad.l + xStep * i, pad.t + cH * (1 - v), 3.5, 0, Math.PI * 2);
      ctx.fillStyle = '#7c6af7';
      ctx.fill();
    });
  }

  // ── Log submission ────────────────────────────────────────────────────────

  document.getElementById('migraineOccurred').addEventListener('change', function () {
    document.getElementById('intensityField').style.display =
      this.value === 'true' ? 'block' : 'none';
  });

  // Default date to today
  document.getElementById('logDate').value = new Date().toISOString().split('T')[0];

  async function submitLog(e) {
    e.preventDefault();
    const id = uid();
    if (!id) { showAlert('Connect a user first.', 'error'); return; }

    const migraineOccurred = document.getElementById('migraineOccurred').value === 'true';
    const body = {
      date: document.getElementById('logDate').value,
      sleep_hours: parseFloat(document.getElementById('sleepHours').value),
      sleep_quality: parseInt(document.getElementById('sleepQuality').value),
      stress_level: parseInt(document.getElementById('stressLevel').value),
      hydration_liters: parseFloat(document.getElementById('hydration').value),
      caffeine_mg: parseFloat(document.getElementById('caffeine').value),
      alcohol_units: parseFloat(document.getElementById('alcohol').value),
      exercise_minutes: parseFloat(document.getElementById('exercise').value),
      weather_pressure_hpa: parseFloat(document.getElementById('pressure').value),
      migraine_occurred: migraineOccurred,
      migraine_intensity: migraineOccurred
        ? parseInt(document.getElementById('migraineIntensity').value)
        : null,
    };

    const btn = document.getElementById('logSubmitBtn');
    btn.disabled = true;
    try {
      const res = await fetch(`${API}/logs/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      if (res.ok) {
        logCount++;
        showAlert('Log submitted successfully!');
        document.getElementById('statLogs').textContent = logCount;
      } else {
        const err = await res.json();
        showAlert('Error: ' + (err.detail || 'Unknown error'), 'error');
      }
    } finally {
      btn.disabled = false;
    }
  }

  // ── Simulation ───────────────────────────────────────────────────────────

  async function runSimulation() {
    const id = uid();
    if (!id) { showAlert('Connect a user first.', 'error'); return; }

    const modifications = {
      sleep_hours: parseFloat(document.getElementById('simSleep').value),
      stress_level: parseInt(document.getElementById('simStress').value),
      hydration_liters: parseFloat(document.getElementById('simHydration').value),
      exercise_minutes: parseFloat(document.getElementById('simExercise').value),
    };

    const payload = { user_id: id, baseline_logs: [], hypothetical_modifications: modifications };
    const res = await fetch(`${API}/simulate/${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (!res.ok) { showAlert('Simulation failed — ensure user is connected.', 'error'); return; }
    const data = await res.json();

    document.getElementById('simResults').style.display = 'block';
    document.getElementById('simRisk').textContent = (data.migraine_risk * 100).toFixed(1) + '%';
    document.getElementById('simUncertainty').textContent = (data.uncertainty * 100).toFixed(1) + '%';
    document.getElementById('simSteps').textContent = (data.trajectory || []).length;
    drawTrajectory('simCanvas', data.trajectory || []);
  }

  // ── Interventions ─────────────────────────────────────────────────────────

  async function loadInterventions() {
    const id = uid();
    if (!id) { showAlert('Connect a user first.', 'error'); return; }
    const res = await fetch(`${API}/interventions/${id}`);
    if (!res.ok) { showAlert('Could not load interventions.', 'error'); return; }
    const data = await res.json();
    const list = document.getElementById('interventionsList');
    if (!data.length) { list.innerHTML = '<p style="color:var(--text-muted)">No suggestions yet — add some daily logs first.</p>'; return; }
    list.innerHTML = data.map(i => {
      const pct = Math.round(i.predicted_risk_reduction * 100);
      const cls = pct >= 20 ? 'green' : pct >= 10 ? 'yellow' : 'red';
      return `
        <div class="intervention">
          <div class="details">
            <div class="type">${i.intervention_type}</div>
            <div class="desc">${i.description}</div>
          </div>
          <span class="badge ${cls}">−${pct}% risk</span>
        </div>`;
    }).join('');
  }
</script>
</body>
</html>
